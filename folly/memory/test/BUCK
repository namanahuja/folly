load("@fbcode_macros//build_defs:cpp_benchmark.bzl", "cpp_benchmark")
load("@fbcode_macros//build_defs:cpp_unittest.bzl", "cpp_unittest")

oncall("fbcode_entropy_wardens_folly")

cpp_unittest(
    name = "arena_test",
    srcs = ["ArenaTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:memory",
        "folly//folly/memory:arena",
        "folly//folly/memory:mallctl_helper",
        "folly//folly/memory:malloc",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "mallctl_helper_test",
    srcs = ["MallctlHelperTest.cpp"],
    headers = [],
    allocator = "jemalloc_debug",
    supports_static_listing = False,
    deps = [
        "fbsource//third-party/jemalloc:headers",
        "folly//folly:c_portability",
        "folly//folly/init:init",
        "folly//folly/memory:mallctl_helper",
        "folly//folly/memory:malloc",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "malloc_test",
    srcs = ["MallocTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/memory:malloc",
        "folly//folly/portability:gtest",
        "folly//folly/portability:malloc",
        "folly//folly/test:test_utils",
    ],
)

cpp_benchmark(
    name = "malloc_benchmark",
    srcs = ["MallocBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:random",
        "folly//folly/memory:malloc",
    ],
)

cpp_unittest(
    name = "memory_resource_test",
    srcs = ["MemoryResourceTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/memory:memory_resource",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "not_null_test",
    srcs = [
        "not_null_test.cpp",
    ],
    supports_static_listing = False,
    deps = [
        "folly//folly/memory:not_null",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "reentrant_allocator_test",
    srcs = ["ReentrantAllocatorTest.cpp"],
    deps = [
        "folly//folly:utility",
        "folly//folly/functional:invoke",
        "folly//folly/memory:reentrant_allocator",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "sanitize_address_test",
    srcs = ["SanitizeAddressTest.cpp"],
    deps = [
        "folly//folly/memory:sanitize_address",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "sanitize_leak_test",
    srcs = ["SanitizeLeakTest.cpp"],
    deps = [
        "folly//folly/memory:sanitize_leak",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "thread_cached_arena_test",
    srcs = ["ThreadCachedArenaTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:memory",
        "folly//folly:range",
        "folly//folly/lang:align",
        "folly//folly/memory:thread_cached_arena",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "uninitialized_memory_hacks_test",
    srcs = [
        "UninitializedMemoryHacksODR.cpp",
        "UninitializedMemoryHacksTest.cpp",
    ],
    deps = [
        "folly//folly:random",
        "folly//folly/memory:uninitialized_memory_hacks",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)
