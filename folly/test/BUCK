load("@fbcode_macros//build_defs:cpp_benchmark.bzl", "cpp_benchmark")
load("@fbcode_macros//build_defs:cpp_binary.bzl", "cpp_binary")
load("@fbcode_macros//build_defs:cpp_library.bzl", "cpp_library")
load("@fbcode_macros//build_defs:cpp_unittest.bzl", "cpp_unittest")

oncall("fbcode_entropy_wardens_folly")

cpp_unittest(
    name = "ahm_int_stress_test",
    srcs = ["AHMIntStressTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:atomic_hash_map",
        "folly//folly:memory",
        "folly//folly:scope_guard",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "unicode_test",
    srcs = ["UnicodeTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:range",
        "folly//folly:unicode",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "arena_smart_ptr_test",
    srcs = ["ArenaSmartPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:memory",
        "folly//folly/memory:arena",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "ascii_case_insensitive_benchmark",
    srcs = ["AsciiCaseInsensitiveBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:range",
    ],
)

cpp_unittest(
    name = "ascii_case_insensitive_test",
    srcs = ["AsciiCaseInsensitiveTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:range",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "base64_test",
    srcs = ["base64_test.cpp"],
    headers = [],
    deps = [
        "folly//folly:base64",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "concurrent_bit_set_test",
    srcs = ["ConcurrentBitSetTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:concurrent_bit_set",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "buffered_atomic_test",
    srcs = ["BufferedAtomicTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly:singleton_thread_local",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "atomic_hash_array_test",
    srcs = ["AtomicHashArrayTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:atomic_hash_array",
        "folly//folly:conv",
        "folly//folly:memory",
        "folly//folly/hash:hash",
        "folly//folly/portability:gtest",
        "folly//folly/portability:string",
        "folly//folly/portability:sys_mman",
    ],
)

cpp_unittest(
    name = "atomic_hash_map_test",
    srcs = ["AtomicHashMapTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:atomic_hash_map",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly/portability:atomic",
        "folly//folly/portability:gtest",
        "folly//folly/portability:sys_time",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "atomic_linked_list_test",
    srcs = ["AtomicLinkedListTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:atomic_linked_list",
        "folly//folly:utility",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization/test:barrier",
    ],
)

cpp_unittest(
    name = "atomic_unordered_map_test",
    srcs = ["AtomicUnorderedMapTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly:atomic_unordered_map",
        "folly//folly:benchmark",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "benchmark_test",
    srcs = ["BenchmarkTest.cpp"],
    deps = [
        "folly//folly:benchmark",
        "folly//folly/detail:perf_scoped",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "benchmark_integration_test",
    srcs = ["BenchmarkIntegrationTest.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:string",
        "folly//folly/container:foreach",
    ],
)

cpp_unittest(
    name = "cancellation_token_test",
    srcs = ["CancellationTokenTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:cancellation_token",
        "folly//folly:optional",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_benchmark(
    name = "chrono_bench",
    srcs = ["ChronoBench.cpp"],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:chrono",
        "folly//folly/chrono:hardware",
        "folly//folly/hash:hash",
        "folly//folly/init:init",
    ],
)

cpp_unittest(
    name = "chrono_test",
    srcs = ["ChronoTest.cpp"],
    deps = [
        "folly//folly:chrono",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "clock_gettime_wrappers_test",
    srcs = ["ClockGettimeWrappersTest.cpp"],
    headers = [],
    deps = [
        ":test_utils",
        "folly//folly:clock_gettime_wrappers",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "concurrent_lazy_test",
    srcs = ["ConcurrentLazyTest.cpp"],
    deps = [
        "folly//folly:concurrent_lazy",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "concurrent_skip_list_benchmark",
    srcs = ["ConcurrentSkipListBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:concurrent_skip_list",
        "folly//folly/hash:hash",
        "folly//folly/portability:gflags",
        "folly//folly/synchronization:rw_spin_lock",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "concurrent_skip_list_test",
    srcs = ["ConcurrentSkipListTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:concurrent_skip_list",
        "folly//folly:memory",
        "folly//folly:string",
        "folly//folly/container:foreach",
        "folly//folly/memory:arena",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "constexpr_math_test",
    srcs = ["ConstexprMathTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:constexpr_math",
        "folly//folly/lang:bits",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "constructor_callback_list_test",
    srcs = ["ConstructorCallbackListTest.cpp"],
    headers = [],
    compiler_flags = [
        # many deps use this, so make sure the unittests pass
        "-Werror",
        "-Wglobal-constructor",
    ],
    deps = [
        "folly//folly:constructor_callback_list",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "constexpr_math_benchmark",
    srcs = ["ConstexprMathBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:constexpr_math",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_binary(
    name = "conv_benchmark",
    srcs = ["ConvBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:cpp_attributes",
        "folly//folly/container:foreach",
        "folly//folly/lang:to_ascii",
    ],
    external_deps = [
        ("boost", None, "boost_lexical_cast"),
    ],
)

cpp_unittest(
    name = "conv_test",
    srcs = ["ConvTest.cpp"],
    headers = [],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:conv",
        "folly//folly:random",
        "folly//folly/container:foreach",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "cpu_id_test",
    srcs = ["CpuIdTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:cpu_id",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "demangle_test",
    srcs = ["DemangleTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:demangle",
        "folly//folly/lang:pretty",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "detail_typelist_test",
    srcs = ["TypeListTest.cpp"],
    deps = [
        "folly//folly/detail:typelist",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "deterministic_schedule",
    srcs = [
        "BufferedAtomic.cpp",
        "DeterministicSchedule.cpp",
    ],
    headers = [
        "BufferedAtomic.h",
        "DeterministicSchedule.h",
    ],
    deps = [
        "folly//folly:random",
        "folly//folly:singleton_thread_local",
    ],
    exported_deps = [
        "folly//folly:scope_guard",
        "folly//folly/concurrency:cache_locality",
        "folly//folly/detail:futex",
        "folly//folly/lang:customization_point",
        "folly//folly/synchronization:atomic_notification",
        "folly//folly/synchronization/detail:atomic_utils",
        "folly//folly/synchronization/test:semaphore",
    ],
    exported_external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "deterministic_schedule_test",
    srcs = ["DeterministicScheduleTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:atomic_util",
    ],
)

cpp_unittest(
    name = "discriminated_ptr_test",
    srcs = ["DiscriminatedPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:discriminated_ptr",
        "folly//folly/portability:gtest",
    ],
)

# This test depends only on :dynamic.  Tests which require other
# dependencies should be added to dynamic_other_test.

cpp_unittest(
    name = "endian_test",
    srcs = ["EndianTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/lang:bits",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "exception_string_test",
    srcs = ["ExceptionStringTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:exception_string",
        "folly//folly:portability",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "exception_test",
    srcs = ["ExceptionTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:exception",
        "folly//folly/experimental:test_util",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "exception_wrapper_benchmark",
    srcs = ["ExceptionWrapperBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:exception_wrapper",
        "folly//folly/portability:gflags",
    ],
)

cpp_unittest(
    name = "exception_wrapper_test",
    srcs = ["ExceptionWrapperTest.cpp"],
    headers = [],
    compiler_specific_flags = {
        "gcc": [
            "-Wno-shadow-compatible-local",
        ],
    },
    deps = [
        "folly//folly:conv",
        "folly//folly:exception_wrapper",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "executor_test",
    srcs = ["ExecutorTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:executor",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "expected_coroutines_bench",
    srcs = ["ExpectedCoroutinesBench.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:exception_wrapper",
        "folly//folly:expected",
        "folly//folly/init:init",
        "folly//folly/lang:keep",
    ],
)

cpp_unittest(
    name = "expected_coroutines_test",
    srcs = ["ExpectedCoroutinesTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:expected",
        "folly//folly:portability",
        "folly//folly:scope_guard",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "expected_test",
    srcs = ["ExpectedTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:expected",
        "folly//folly:portability",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_benchmark(
    name = "fbstring_benchmark",
    srcs = ["FBStringBenchmark.cpp"],
    headers = ["FBStringTestBenchmarks.cpp.h"],
    allocator = "jemalloc",
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:fbstring",
        "folly//folly:random",
        "folly//folly/container:foreach",
        "folly//folly/portability:gflags",
    ],
)

cpp_unittest(
    name = "fbstring_test",
    srcs = ["FBStringTest.cpp"],
    headers = [],
    allocator = "jemalloc",
    deps = [
        ":test_utils",
        "folly//folly:conv",
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly:random",
        "folly//folly:utility",
        "folly//folly/container:foreach",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_algorithm"),
    ],
)

cpp_library(
    name = "fbvector_test_util",
    srcs = [
        "FBVectorTestUtil.cpp",
    ],
    exported_deps = [
        "folly//folly:fbstring",
        "folly//folly:random",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "file_test",
    srcs = ["FileTest.cpp"],
    headers = [],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:file",
        "folly//folly:string",
        "folly//folly/portability:fcntl",
        "folly//folly/portability:filesystem",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "file_lock_test",
    srcs = ["FileLockTest.cpp"],
    headers = [],
    env = {
        "FOLLY_FILE_LOCK_TEST_HELPER": "$(exe_target :file_test_lock_helper)",
    },
    deps = [
        "folly//folly:file",
        "folly//folly:string",
        "folly//folly:subprocess",
        "folly//folly/experimental:test_util",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        ("boost", None, "boost_thread"),
        "glog",
    ],
)

cpp_binary(
    name = "file_test_lock_helper",
    srcs = ["FileTestLockHelper.cpp"],
    headers = [],
    deps = [
        "folly//folly:file",
        "folly//folly/portability:gflags",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "file_util_test",
    srcs = ["FileUtilTest.cpp"],
    headers = [],
    extract_helper_lib = False,
    deps = [
        "folly//folly:exception",
        "folly//folly:file",
        "folly//folly:file_util",
        "folly//folly:range",
        "folly//folly:string",
        "folly//folly/detail:file_util_detail",
        "folly//folly/detail:file_util_vector_detail",
        "folly//folly/experimental:test_util",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
        ("glibc", None, "dl"),
    ],
)

cpp_benchmark(
    name = "fingerprint_benchmark",
    srcs = ["FingerprintBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:fingerprint",
        "folly//folly:format",
        "folly//folly/detail:slow_fingerprint",
    ],
)

cpp_unittest(
    name = "fingerprint_test",
    srcs = ["FingerprintTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:fingerprint",
        "folly//folly/detail:slow_fingerprint",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "fixed_string_test",
    srcs = ["FixedStringTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:fixed_string",
        "folly//folly:range",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "format_benchmark",
    srcs = ["FormatBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    compiler_specific_flags = {
        "clang": [
            "-ftemplate-depth=512",
        ],
    },
    deps = [
        "folly//folly:benchmark",
        "folly//folly:fbvector",
        "folly//folly:format",
        "folly//folly:utility",
        "folly//folly/init:init",
        "folly//folly/json:dynamic",
    ],
    external_deps = [
        "glog",
    ],
)

# This test depends only on :format.  Tests for user-defined formatters
# should be added to format_other_test.
cpp_unittest(
    name = "format_test",
    srcs = ["FormatTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:format",
        "folly//folly:utility",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "format_other_test",
    srcs = ["FormatOtherTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:fbvector",
        "folly//folly:file_util",
        "folly//folly:format",
        "folly//folly:portability",
        "folly//folly:small_vector",
        "folly//folly/json:dynamic",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "function_ref_test",
    srcs = ["FunctionRefTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:function",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "function_ref_benchmark",
    srcs = ["FunctionRefBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:function",
        "folly//folly:random",
        "folly//folly/synchronization/detail:inline_function_ref",
    ],
)

cpp_unittest(
    name = "function_test",
    srcs = ["FunctionTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:function",
        "folly//folly:memory",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "futex_test",
    srcs = ["FutexTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly:chrono",
        "folly//folly/detail:futex",
        "folly//folly/portability:gtest",
        "folly//folly/portability:time",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "group_varint_test",
    srcs = ["GroupVarintTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:group_varint",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "group_varint_test_ssse3",
    srcs = ["GroupVarintTest.cpp"],
    headers = [],
    compiler_flags = ["-mssse3"],
    deps = [
        "folly//folly:group_varint",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "indestructible_test",
    srcs = ["IndestructibleTest.cpp"],
    deps = [
        "folly//folly:indestructible",
        "folly//folly:memory",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "indexed_mem_pool_test",
    srcs = ["IndexedMemPoolTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly:indexed_mem_pool",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/portability:unistd",
    ],
)

cpp_benchmark(
    name = "ip_address_benchmark",
    srcs = ["IPAddressBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:network_address",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "ip_address_test",
    srcs = ["IPAddressTest.cpp"],
    supports_static_listing = False,
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:network_address",
        "folly//folly:string",
        "folly//folly/container:bit_iterator",
        "folly//folly/detail:ip_address_source",
        "folly//folly/lang:bits",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "iterators_test",
    srcs = ["IteratorsTest.cpp"],
    deps = [
        "folly//folly/container:array",
        "folly//folly/detail:iterators",
        "folly//folly/portability:gtest",
    ],
)

# This test depends only on :json.  Tests which require other
# dependencies should be added to json_other_test.

cpp_unittest(
    name = "lazy_test",
    srcs = ["LazyTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:lazy",
        "folly//folly/portability:gtest",
    ],
)

cpp_binary(
    name = "glog_benchmark",
    srcs = ["GLogBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:glog",
    ],
)

cpp_unittest(
    name = "glog_test",
    srcs = ["GLogTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:glog",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "mac_address_test",
    srcs = ["MacAddressTest.cpp"],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:network_address",
        "folly//folly/portability:gtest",
    ],
)

cpp_binary(
    name = "math_benchmark",
    srcs = ["MathBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:math",
    ],
)

cpp_unittest(
    name = "math_test",
    srcs = ["MathTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:math",
        "folly//folly:portability",
        "folly//folly/functional:invoke",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

# Test MaybeManagedPtr with default settings and on c++17 and c++20.
# We test c++17 and c++20 explicitly since c++20 can synthesize `operator!=` whereas c++17 cannot.
cpp_unittest(
    name = "maybe_managed_ptr_test",
    srcs = ["MaybeManagedPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:maybe_managed_ptr",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "maybe_managed_ptr_test_c++17",
    srcs = ["MaybeManagedPtrTest.cpp"],
    headers = [],
    compiler_flags = [
        "-std=c++17",
    ],
    deps = [
        "folly//folly:maybe_managed_ptr",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "maybe_managed_ptr_test_c++20",
    srcs = ["MaybeManagedPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:maybe_managed_ptr",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "memset_test",
    srcs = [
        "MemsetTest.cpp",
    ],
    deps = [
        "folly//folly:memset",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "memset_benchmark",
    srcs = ["MemsetBenchmark.cpp"],
    headers = [],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:benchmark",
        "folly//folly:memset",
        "folly//folly:preprocessor",
        "folly//folly/portability:gflags",
    ],
)

cpp_unittest(
    name = "memcpy_test",
    srcs = ["MemcpyTest.cpp"],
    headers = [],
    supports_static_listing = False,
    deps = [
        "folly//folly:memcpy",
        "folly//folly:portability",
        "folly//folly/portability:gtest",
    ],
)

cpp_binary(
    name = "memcpy_benchmark",
    srcs = ["MemcpyBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:memcpy",
        "folly//folly/portability:unistd",
    ],
)

cpp_unittest(
    name = "memcpy_use_test",
    srcs = ["MemcpyUseTest.cpp"],
    deps = [
        "folly//folly:memcpy-use",  # @manual
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "memory_test",
    srcs = ["MemoryTest.cpp"],
    headers = [],
    supports_static_listing = False,
    deps = [
        "folly//folly:constexpr_math",
        "folly//folly:memory",
        "folly//folly:string",
        "folly//folly/lang:keep",
        "folly//folly/memory:arena",
        "folly//folly/portability:asm",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_binary(
    name = "memory_idler_benchmark",
    srcs = ["MemoryIdlerBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly/detail:memory_idler",
    ],
)

cpp_unittest(
    name = "memory_idler_test",
    srcs = ["MemoryIdlerTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/detail:memory_idler",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "move_wrapper_test",
    srcs = ["MoveWrapperTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:move_wrapper",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "mpmc_pipeline_test",
    srcs = ["MPMCPipelineTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:conv",
        "folly//folly:mpmc_pipeline",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "mpmc_queue_test",
    srcs = ["MPMCQueueTest.cpp"],
    headers = [],
    deps = [
        ":deterministic_schedule",
        "folly//folly:format",
        "folly//folly:memory",
        "folly//folly:mpmc_queue",
        "folly//folly:stop_watch",
        "folly//folly/portability:gtest",
        "folly//folly/portability:sys_resource",
        "folly//folly/portability:sys_time",
        "folly//folly/portability:unistd",
    ],
    external_deps = [
        "boost",
        ("boost", None, "boost_thread"),
    ],
)

cpp_library(
    name = "observer_container_test_util",
    headers = ["ObserverContainerTestUtil.h"],
    exported_deps = [
        "folly//folly:function",
        "folly//folly:optional",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "observer_container_test",
    srcs = ["ObserverContainerTest.cpp"],
    headers = [],
    deps = [
        ":observer_container_test_util",
        "folly//folly:observer_container",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "optional_test",
    srcs = ["OptionalTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:cpp_attributes",
        "folly//folly:optional",
        "folly//folly:portability",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "optional_coroutines_test",
    srcs = ["OptionalCoroutinesTest.cpp"],
    headers = [],
    compiler_specific_flags = {
        "clang": [
            "-O1",  # BUGBUG https://bugs.llvm.org/show_bug.cgi?id=34289
        ],
    },
    deps = [
        "folly//folly:optional",
        "folly//folly:portability",
        "folly//folly:scope_guard",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "replaceable_test",
    srcs = ["ReplaceableTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:replaceable",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "overload_test",
    srcs = ["OverloadTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:discriminated_ptr",
        "folly//folly:overload",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        ("boost", None, "boost_variant"),
    ],
)

cpp_unittest(
    name = "packed_sync_ptr_test",
    srcs = ["PackedSyncPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:packed_sync_ptr",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "padded_test",
    srcs = ["PaddedTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:padded",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "poly_test",
    srcs = ["PolyTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly:cpp_attributes",
        "folly//folly:poly",
        "folly//folly/poly:basic_interfaces",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "portability_test",
    srcs = ["PortabilityTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:portability",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "producer_consumer_queue_benchmark",
    srcs = ["ProducerConsumerQueueBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:producer_consumer_queue",
        "folly//folly/portability:gflags",
        "folly//folly/portability:pthread",
        "folly//folly/stats:histogram",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "producer_consumer_queue_test",
    srcs = ["ProducerConsumerQueueTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:producer_consumer_queue",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_binary(
    name = "random_benchmark",
    srcs = ["RandomBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:random",
        "folly//folly/container:foreach",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "random_test",
    srcs = ["RandomTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:random",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_benchmark(
    name = "range_find_benchmark",
    srcs = ["RangeFindBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:range",
        "folly//folly/container:foreach",
    ],
)

cpp_unittest(
    name = "range_test",
    srcs = ["RangeTest.cpp"],
    headers = [],
    compiler_specific_flags = {
        "gcc": [
            "-Wno-shadow-compatible-local",
        ],
    },
    deps = [
        "fbsource//third-party/range-v3:range-v3",
        "folly//folly:cpp_attributes",
        "folly//folly:memory",
        "folly//folly:range",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/portability:sys_mman",
    ],
    external_deps = [
        ("boost", None, "boost_algorithm"),
        ("boost", None, "boost_range"),
    ],
)

cpp_unittest(
    name = "scope_guard_test",
    srcs = ["ScopeGuardTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:scope_guard",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "shared_mutex_test",
    srcs = ["SharedMutexTest.cpp"],
    headers = [],
    compiler_specific_flags = {
        "gcc": [
            "-Wno-shadow-compatible-local",
        ],
    },
    deps = [
        ":deterministic_schedule",
        ":test_utils",
        "folly//folly:benchmark",
        "folly//folly:mpmc_queue",
        "folly//folly:shared_mutex",
        "folly//folly/fibers:core",
        "folly//folly/fibers:timed_mutex",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:rw_spin_lock",
    ],
    external_deps = [
        ("boost", None, "boost_thread"),
    ],
)

cpp_benchmark(
    name = "singleton_benchmark",
    srcs = ["SingletonBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:memory",
        "folly//folly:singleton",
        "folly//folly:singleton_thread_local",
        "folly//folly/portability:gflags",
    ],
)

cpp_unittest(
    name = "singleton_test",
    srcs = ["SingletonTest.cpp"],
    headers = [],
    deps = [
        ":singleton_test_structs",
        ":test_utils",
        "folly//folly:singleton",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/io/async:async_base",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_thread"),
    ],
)

cpp_unittest(
    name = "singleton_test_global",
    srcs = ["SingletonTestGlobal.cpp"],
    headers = [],
    deps = [
        ":singleton_test_structs",
        "folly//folly:benchmark",
        "folly//folly:singleton",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "singleton_test_structs",
    srcs = ["SingletonTestStructs.cpp"],
    headers = ["SingletonTestStructs.h"],
    exported_deps = [
        "folly//folly/portability:gtest",
    ],
    exported_external_deps = [
        "glog",
    ],
)

cpp_binary(
    name = "singleton_thread_local_overload.so",
    srcs = ["SingletonThreadLocalTestOverload.cpp"],
    dlopen_enabled = True,
    deps = [
        "folly//folly:singleton_thread_local",
    ],
)

cpp_unittest(
    name = "singleton_thread_local_test",
    srcs = ["SingletonThreadLocalTest.cpp"],
    headers = [],
    resources = [
        ":singleton_thread_local_overload.so",
    ],
    deps = [
        ":singleton_thread_local_overload.so",  # @manual
        "folly//folly:singleton_thread_local",
        "folly//folly:string",
        "folly//folly:synchronized",
        "folly//folly/experimental:test_util",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        ("boost", None, "boost_thread"),
        ("glibc", None, "dl"),
    ],
)

cpp_unittest(
    name = "socket_address_test",
    srcs = ["SocketAddressTest.cpp"],
    deps = [
        ":socket_address_test_helper",
        "folly//folly:network_address",
        "folly//folly:string",
        "folly//folly/container:array",
        "folly//folly/experimental:test_util",
        "folly//folly/portability:gtest",
        "folly//folly/portability:sockets",
    ],
)

cpp_library(
    name = "socket_address_test_helper",
    srcs = ["SocketAddressTestHelper.cpp"],
    headers = ["SocketAddressTestHelper.h"],
    deps = [
        "folly//folly/portability:sockets",
    ],
)

cpp_unittest(
    name = "spin_lock_test",
    srcs = ["SpinLockTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:random",
        "folly//folly:spin_lock",
        "folly//folly:utility",
        "folly//folly/portability:asm",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "string_benchmark",
    srcs = ["StringBenchmark.cpp"],
    headers = [],
    args = [
        "--json",
    ],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:benchmark",
        "folly//folly:format",
        "folly//folly:random",
        "folly//folly:string",
    ],
    external_deps = [("boost", None, "boost_algorithm")],
)

cpp_unittest(
    name = "string_test",
    srcs = ["StringTest.cpp"],
    headers = [],
    deps = [
        ":test_utils",
        "folly//folly:fbvector",
        "folly//folly:string",
        "folly//folly/container:array",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_regex"),
    ],
)

cpp_benchmark(
    name = "subprocess_bench",
    srcs = ["SubprocessBench.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:file",
        "folly//folly:subprocess",
    ],
)

cpp_unittest(
    name = "subprocess_test",
    srcs = ["SubprocessTest.cpp"],
    headers = [],
    resources = [
        ":subprocess_test_parent_death_helper",
    ],
    deps = [
        ":subprocess_test_parent_death_helper",  # @manual
        "folly//folly:exception",
        "folly//folly:file_util",
        "folly//folly:format",
        "folly//folly:string",
        "folly//folly:subprocess",
        "folly//folly/experimental:test_util",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/gen:base",
        "folly//folly/gen:file",
        "folly//folly/gen:string",
        "folly//folly/portability:gtest",
        "folly//folly/portability:unistd",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_container"),
    ],
)

cpp_binary(
    name = "subprocess_test_parent_death_helper",
    srcs = ["SubprocessTestParentDeathHelper.cpp"],
    headers = [],
    deps = [
        "folly//folly:conv",
        "folly//folly:subprocess",
        "folly//folly/portability:gflags",
        "folly//folly/portability:unistd",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "synchronized_test",
    srcs = ["SynchronizedTest.cpp"],
    headers = [],
    deps = [
        ":synchronized_test_lib",
        "folly//folly:function",
        "folly//folly:portability",
        "folly//folly:scope_guard",
        "folly//folly:shared_mutex",
        "folly//folly:spin_lock",
        "folly//folly:synchronized",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:distributed_mutex",
        "folly//folly/synchronization:rw_spin_lock",
    ],
)

cpp_benchmark(
    name = "synchronized_benchmark",
    srcs = ["SynchronizedBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:synchronized",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "synchronized_ptr_test",
    srcs = ["SynchronizedPtrTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:optional",
        "folly//folly:replaceable",
        "folly//folly:synchronized_ptr",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:rw_spin_lock",
    ],
)

cpp_library(
    name = "synchronized_test_lib",
    headers = [
        "SynchronizedTestLib.h",
        "SynchronizedTestLib-inl.h",
    ],
    exported_deps = [
        "folly//folly:random",
        "folly//folly:synchronized",
        "folly//folly/container:foreach",
        "folly//folly/portability:gtest",
    ],
    exported_external_deps = [
        "glog",
    ],
)

cpp_library(
    name = "test_utils",
    headers = ["TestUtils.h"],
    exported_deps = [
        "folly//folly:conv",
        "folly//folly:exception_string",
        "folly//folly:fbstring",
        "folly//folly:fixed_string",
        "folly//folly:range",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "thread_cached_int_test",
    srcs = ["ThreadCachedIntTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:thread_cached_int",
        "folly//folly/container:foreach",
        "folly//folly/hash:hash",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
        "folly//folly/system:thread_id",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_binary(
    name = "thread_local_benchmark",
    srcs = ["ThreadLocalBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:thread_local",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/portability:gflags",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_thread"),
    ],
)

cpp_binary(
    name = "thread_local_access_benchmark",
    srcs = ["ThreadLocalAccessBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:thread_local",
    ],
)

cpp_binary(
    name = "thread_local_destroy_benchmark",
    srcs = ["ThreadLocalDestroyBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:thread_local",
    ],
)

cpp_binary(
    name = "thread_local_test_lib.so",
    srcs = ["ThreadLocalTestLib.cpp"],
    headers = [],
    dlopen_enabled = True,
    deps = [
        "folly//folly:thread_local",
    ],
)

cpp_unittest(
    name = "thread_local_test",
    srcs = ["ThreadLocalTest.cpp"],
    headers = [],
    resources = [
        ":thread_local_test_lib.so",
    ],
    deps = [
        "folly//folly:memory",
        "folly//folly:thread_local",
        "folly//folly/experimental:test_util",
        "folly//folly/experimental/io:fs_util",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
        "folly//folly/portability:unistd",
        "folly//folly/synchronization:baton",
        "folly//folly/system:thread_id",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_thread"),
        ("glibc", None, "dl"),
    ],
)

cpp_unittest(
    name = "timeout_queue_test",
    srcs = ["TimeoutQueueTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:timeout_queue",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "token_bucket_test",
    srcs = ["TokenBucketTest.cpp"],
    headers = ["TokenBucketTest.h"],
    supports_static_listing = False,
    deps = [
        "folly//folly:string",
        "folly//folly:token_bucket",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "traits_test",
    srcs = ["TraitsTest.cpp"],
    headers = [],
    default_strip_mode = "full",
    deps = [
        "folly//folly:cpp_attributes",
        "folly//folly:scope_guard",
        "folly//folly:traits",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "try_test",
    srcs = ["TryTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:memory",
        "folly//folly:traits",
        "folly//folly:try",
        "folly//folly/lang:exception",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "unit_test",
    srcs = ["UnitTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:unit",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "uri_benchmark",
    srcs = ["UriBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:uri",
        "folly//folly/init:init",
    ],
)

cpp_unittest(
    name = "uri_test",
    srcs = ["UriTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:uri",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
        ("boost", None, "boost_algorithm"),
    ],
)

cpp_unittest(
    name = "utf8_string_test",
    srcs = ["UTF8StringTest.cpp"],
    headers = [],
    deps = [
        ":test_utils",
        "folly//folly:range",
        "folly//folly:utf8_string",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "utility_test",
    srcs = ["UtilityTest.cpp"],
    deps = [
        "folly//folly:utility",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "varint_test",
    srcs = ["VarintTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:random",
        "folly//folly:varint",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_library(
    name = "json_mock_util",
    headers = [
        "JsonMockUtil.h",
    ],
    exported_deps = [
        "folly//folly/json:json_mock_util",
    ],
)

cpp_library(
    name = "json_test_util",
    headers = [
        "JsonTestUtil.h",
    ],
    exported_deps = [
        "folly//folly/json:json_test_util",
    ],
)

cpp_unittest(
    name = "test_utils_test",
    srcs = ["TestUtilsTest.cpp"],
    headers = [],
    deps = [
        ":test_utils",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "comparison_operator_test_util",
    headers = ["ComparisonOperatorTestUtil.h"],
    exported_deps = [
        "folly//folly/portability:gtest",
    ],
)
