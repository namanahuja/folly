load("@fbcode_macros//build_defs:cpp_benchmark.bzl", "cpp_benchmark")
load("@fbcode_macros//build_defs:cpp_binary.bzl", "cpp_binary")
load("@fbcode_macros//build_defs:cpp_library.bzl", "cpp_library")
load("@fbcode_macros//build_defs:cpp_unittest.bzl", "cpp_unittest")

oncall("fbcode_entropy_wardens_folly")

cpp_unittest(
    name = "access_test",
    srcs = ["AccessTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:access",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "array_test",
    srcs = ["ArrayTest.cpp"],
    headers = [],
    supports_static_listing = False,
    deps = [
        "folly//folly/container:array",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "bit_iterator_bench",
    srcs = ["BitIteratorBench.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:small_vector",
        "folly//folly/container:bit_iterator",
        "folly//folly/init:init",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "bit_iterator_test",
    srcs = ["BitIteratorTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:bit_iterator",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "enumerate_test",
    srcs = ["EnumerateTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:range",
        "folly//folly/container:enumerate",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "evicting_cache_map_bench",
    srcs = ["EvictingCacheMapBench.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly/container:evicting_cache_map",
    ],
)

cpp_unittest(
    name = "evicting_cache_map_test",
    srcs = ["EvictingCacheMapTest.cpp"],
    headers = [],
    allocator = "jemalloc_debug",
    deps = [
        "folly//folly/container:evicting_cache_map",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "f14_test_util",
    headers = [
        "F14TestUtil.h",
    ],
    exported_deps = [
        "folly//folly/container/detail:f14_hash_detail",
    ],
)

cpp_unittest(
    name = "f14_fwd_test",
    srcs = [
        "F14FwdTest.cpp",
    ],
    deps = [
        "folly//folly/container:f14_hash_fwd",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "f14_map_test",
    srcs = [
        "F14MapTest.cpp",
    ],
    deps = [
        ":f14_test_util",
        ":tracking_types",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly/container:f14_hash",
        "folly//folly/hash:hash",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "f14_map_fallback_test",
    srcs = [
        "F14MapTest.cpp",
    ],
    preprocessor_flags = ["-DFOLLY_F14_FORCE_FALLBACK=1"],
    deps = [
        ":f14_test_util",
        ":tracking_types",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly/container:f14_hash",
        "folly//folly/hash:hash",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "f14_policy_test",
    srcs = [
        "F14PolicyTest.cpp",
    ],
    deps = [
        "folly//folly/container:f14_hash",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "f14_set_test",
    srcs = [
        "F14SetTest.cpp",
    ],
    deps = [
        ":f14_test_util",
        ":tracking_types",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly/container:f14_hash",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "f14_set_fallback_test",
    srcs = [
        "F14SetTest.cpp",
    ],
    preprocessor_flags = ["-DFOLLY_F14_FORCE_FALLBACK=1"],
    deps = [
        ":f14_test_util",
        ":tracking_types",
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly/container:f14_hash",
        "folly//folly/lang:keep",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "heap_vector_types_test",
    srcs = ["heap_vector_types_test.cpp"],
    headers = [],
    deps = [
        "folly//folly:random",
        "folly//folly:range",
        "folly//folly:small_vector",
        "folly//folly:sorted_vector_types",
        "folly//folly:utility",
        "folly//folly/container:heap_vector_types",
        "folly//folly/memory:malloc",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "f14_interprocess_test",
    srcs = [
        "F14InterprocessTest.cpp",
    ],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:random",
        "folly//folly:traits",
        "folly//folly/container:f14_hash",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        ("boost", None, "boost_interprocess"),
        ("glibc", None, "rt"),  # @manual
    ],
)

cpp_binary(
    name = "f14_small_overheads",
    srcs = [
        "F14SmallOverheads.cpp",
    ],
    deps = [
        "folly//folly/container:f14_hash",
    ],
)

cpp_unittest(
    name = "f14_asan_support_test",
    srcs = [
        "F14AsanSupportTest.cpp",
    ],
    deps = [
        "folly//folly:portability",
        "folly//folly/container:f14_hash",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "foreach_benchmark",
    srcs = ["ForeachBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:random",
        "folly//folly/container:enumerate",
        "folly//folly/container:foreach",
        "folly//folly/init:init",
    ],
)

cpp_unittest(
    name = "foreach_test",
    srcs = ["ForeachTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:foreach",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "heterogeneous_access_test",
    srcs = [
        "HeterogeneousAccessTest.cpp",
    ],
    deps = [
        "folly//folly:fbstring",
        "folly//folly:portability",
        "folly//folly:range",
        "folly//folly:small_vector",
        "folly//folly:traits",
        "folly//folly/container:heterogeneous_access",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "iterator_test",
    srcs = ["IteratorTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:iterator",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "merge_test",
    srcs = ["MergeTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:merge",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "range_traits_test",
    srcs = ["range_traits_test.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:range_traits",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "sparse_byte_set_benchmark",
    srcs = ["SparseByteSetBenchmark.cpp"],
    headers = [],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:benchmark",
        "folly//folly:format",
        "folly//folly/container:sparse_byte_set",
        "folly//folly/portability:gflags",
    ],
)

cpp_unittest(
    name = "sparse_byte_set_test",
    srcs = ["SparseByteSetTest.cpp"],
    headers = [],
    deps = [
        "folly//folly/container:sparse_byte_set",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "tracking_types",
    headers = [
        "TrackingTypes.h",
    ],
    exported_deps = [
        "folly//folly:function",
        "folly//folly/hash:hash",
        "folly//folly/lang:safe_assert",
        "folly//folly/portability:asm",
    ],
)

cpp_unittest(
    name = "tape_test",
    srcs = ["tape_test.cpp"],
    deps = [
        "folly//folly:small_vector",
        "folly//folly/container:tape",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "tape_bench",
    srcs = ["tape_bench.cpp"],
    deps = [
        "folly//folly:benchmark",
        "folly//folly/container:tape",
        "folly//folly/init:init",
    ],
)

cpp_unittest(
    name = "util_test",
    srcs = ["UtilTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:optional",
        "folly//folly:range",
        "folly//folly/container/detail:util",
        "folly//folly/container/test:tracking_types",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "weighted_evicting_cache_map_test",
    srcs = ["WeightedEvictingCacheMapTest.cpp"],
    headers = [],
    allocator = "jemalloc_debug",
    deps = [
        "folly//folly/container:weighted_evicting_cache_map",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "intrusive_heap_test",
    srcs = ["IntrusiveHeapTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:random",
        "folly//folly/container:intrusive_heap",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
)

cpp_binary(
    name = "hash_maps_bench",
    srcs = ["HashMapsBench.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:conv",
        "folly//folly:format",
        "folly//folly:function",
        "folly//folly/container:f14_hash",
        "folly//folly/hash:hash",
        "folly//folly/init:init",
        "folly//folly/portability:gflags",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "reserve_test",
    srcs = ["ReserveTest.cpp"],
    deps = [
        "folly//folly/container:f14_hash",
        "folly//folly/container:reserve",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "fbvector_benchmark",
    srcs = ["FBVectorBenchmark.cpp"],
    headers = ["FBVectorBenchmarks.cpp.h"],
    args = [
        "--json",
    ],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:fbvector",
        "folly//folly:small_vector",
        "folly//folly:traits",
        "folly//folly/container:foreach",
        "folly//folly/portability:gflags",
        "folly//folly/test:fbvector_test_util",
    ],
)

cpp_unittest(
    name = "fbvector_test",
    srcs = ["FBVectorTest.cpp"],
    headers = [
        "FBVectorTests.cpp.h",
    ],
    deps = [
        "folly//folly:fbstring",
        "folly//folly:fbvector",
        "folly//folly:random",
        "folly//folly:traits",
        "folly//folly/container:foreach",
        "folly//folly/portability:gtest",
        "folly//folly/test:fbvector_test_util",
    ],
)

cpp_unittest(
    name = "map_util_test",
    srcs = ["MapUtilTest.cpp"],
    headers = [],
    deps = [
        "folly//folly:map_util",
        "folly//folly:sorted_vector_types",
        "folly//folly:traits",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "small_vector_test",
    srcs = ["small_vector_test.cpp"],
    headers = [],
    supports_static_listing = False,
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:conv",
        "folly//folly:small_vector",
        "folly//folly:sorted_vector_types",
        "folly//folly:traits",
        "folly//folly/container:iterator",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        ("boost", None, "boost_algorithm"),
    ],
)

cpp_unittest(
    name = "sorted_vector_types_test",
    srcs = ["sorted_vector_test.cpp"],
    headers = [],
    deps = [
        "folly//folly:optional",
        "folly//folly:range",
        "folly//folly:small_vector",
        "folly//folly:sorted_vector_types",
        "folly//folly:utility",
        "folly//folly/memory:malloc",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)
