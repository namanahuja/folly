load("@fbcode_macros//build_defs:cpp_binary.bzl", "cpp_binary")
load("@fbcode_macros//build_defs:cpp_library.bzl", "cpp_library")
load("@fbcode_macros//build_defs:cpp_unittest.bzl", "cpp_unittest")
load("@fbcode_macros//build_defs:python_unittest.bzl", "python_unittest")
load("@fbsource//tools/build_defs/buck2:is_buck2.bzl", "is_buck2")

oncall("fbcode_entropy_wardens_folly")

cpp_unittest(
    name = "async_file_writer_test",
    srcs = ["AsyncFileWriterTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly:exception",
        "folly//folly:file",
        "folly//folly:file_util",
        "folly//folly:string",
        "folly//folly:synchronized",
        "folly//folly/experimental:test_util",
        "folly//folly/futures:core",
        "folly//folly/init:init",
        "folly//folly/lang:safe_assert",
        "folly//folly/logging:init",
        "folly//folly/logging:logging",
        "folly//folly/portability:config",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/portability:unistd",
        "folly//folly/system:thread_id",
        "folly//folly/system:thread_name",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "async_log_writer_test",
    srcs = ["AsyncLogWriterTest.cpp"],
    deps = [
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "config_parser_test",
    srcs = ["ConfigParserTest.cpp"],
    deps = [
        ":config_helpers",
        "folly//folly:string",
        "folly//folly/json:dynamic",
        "folly//folly/logging:init",
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "config_update_test",
    srcs = ["ConfigUpdateTest.cpp"],
    deps = [
        ":config_helpers",
        ":test_handler",
        "folly//folly/json:dynamic",
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

python_unittest(
    name = "fatal_test",
    srcs = ["fatal_test.py"],
    env = {
        "FOLLY_FATAL_HELPER": "$(location folly//folly/logging/test/helpers:fatal_helper)",
    },
)

python_unittest(
    name = "log_after_main",
    srcs = ["log_after_main.py"],
    env = {
        "FOLLY_LOG_AFTER_MAIN_HELPER": "$(location folly//folly/logging/test/helpers:log_after_main)",
        "FOLLY_LOG_AFTER_MAIN_NO_INIT_HELPER": "$(location folly//folly/logging/test/helpers:log_after_main_no_init)",
    },
)

cpp_unittest(
    name = "file_handler_factory_test",
    srcs = ["FileHandlerFactoryTest.cpp"],
    deps = [
        "folly//folly:exception",
        "folly//folly/experimental:test_util",
        "folly//folly/logging:file_handler_factory",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "custom_log_formatter_test",
    srcs = ["CustomLogFormatterTest.cpp"],
    deps = [
        "folly//folly:format",
        "folly//folly/init:init",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
        "folly//folly/portability:stdlib",
    ],
)

cpp_unittest(
    name = "glog_formatter_test",
    srcs = ["GlogFormatterTest.cpp"],
    deps = [
        "folly//folly:format",
        "folly//folly/init:init",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
        "folly//folly/portability:stdlib",
        "folly//folly/system:thread_name",
    ],
)

cpp_unittest(
    name = "immediate_file_writer_test",
    srcs = ["ImmediateFileWriterTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly:exception",
        "folly//folly:file_util",
        "folly//folly/experimental:test_util",
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "init_test",
    srcs = ["InitTest.cpp"],
    deps = [
        ":config_helpers",
        "folly//folly/logging:init",
        "folly//folly/logging:logging",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "log_category_test",
    srcs = ["LogCategoryTest.cpp"],
    deps = [
        ":test_handler",
        "folly//folly:conv",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "logger_db_test",
    srcs = ["LoggerDBTest.cpp"],
    deps = [
        ":test_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "logger_test",
    srcs = ["LoggerTest.cpp"],
    deps = [
        "fbsource//third-party/fmt:fmt",
        ":test_handler",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "log_level_test",
    srcs = ["LogLevelTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly:random",
        "folly//folly/logging:log_level",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "log_message_test",
    srcs = ["LogMessageTest.cpp"],
    deps = [
        "folly//folly:string",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "log_name_test",
    srcs = ["LogNameTest.cpp"],
    deps = [
        "folly//folly/logging:log_name",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "log_stream_test",
    srcs = ["LogStreamTest.cpp"],
    deps = [
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "rate_limiter_test",
    srcs = ["RateLimiterTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly/logging:rate_limiter",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "standard_log_handler_test",
    srcs = ["StandardLogHandlerTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:log_level",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
    ],
)

cpp_library(
    name = "config_helpers",
    srcs = ["ConfigHelpers.cpp"],
    headers = ["ConfigHelpers.h"],
    deps = [
        "folly//folly:string",
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
    ],
)

cpp_unittest(
    name = "sync_level_test",
    srcs = ["SyncLevelTest.cpp"],
    deps = [
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/test:test_utils",
    ],
)

cpp_library(
    name = "test_handler",
    srcs = ["TestLogHandler.cpp"],
    headers = ["TestLogHandler.h"],
    deps = [
        "folly//folly:map_util",
    ],
    exported_deps = [
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
    ],
)

cpp_library(
    name = "xlog_test_lib",
    srcs = [
        "XlogFile1.cpp",
        "XlogFile2.cpp",
    ],
    headers = [
        "XlogHeader1.h",
        "XlogHeader2.h",
    ],
    exported_deps = [
        "folly//folly:range",
        "folly//folly/logging:logging",
    ],
)

cpp_binary(
    name = "xlog_bench",
    srcs = ["XlogBench.cpp"],
    deps = [
        "folly//folly:benchmark",
        "folly//folly/init:init",
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gflags",
    ],
    external_deps = [
        ("boost", None, "boost_preprocessor"),
        ("boost", None, "boost_thread"),
    ],
)

cpp_unittest(
    name = "xlog_test",
    srcs = ["XlogTest.cpp"],
    preprocessor_flags = [
        "-DFOLLY_XLOG_SUPPORT_BUCK2" if is_buck2() else "-DFOLLY_XLOG_SUPPORT_BUCK1",
    ],
    deps = [
        ":test_handler",
        ":xlog_test_lib",
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:constexpr",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "standard_log_handler_factory_test",
    srcs = ["StandardLogHandlerFactoryTest.cpp"],
    deps = [
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gmock",
        "folly//folly/test:test_utils",
    ],
)

cpp_unittest(
    name = "bridge_from_google_logging_test",
    srcs = ["BridgeFromGoogleLoggingTest.cpp"],
    deps = [
        ":test_handler",
        "folly//folly/logging:glog_bridge",
        "folly//folly/logging:init",
        "folly//folly/logging:log_handler",
        "folly//folly/logging:logging",
        "folly//folly/portability:gtest",
        "folly//folly/test:test_utils",
    ],
)
