load("@fbcode_macros//build_defs:cpp_benchmark.bzl", "cpp_benchmark")
load("@fbcode_macros//build_defs:cpp_library.bzl", "cpp_library")
load("@fbcode_macros//build_defs:cpp_unittest.bzl", "cpp_unittest")

oncall("fbcode_entropy_wardens_folly")

cpp_unittest(
    name = "AsyncTest",
    srcs = ["AsyncTest.cpp"],
    deps = [
        "folly//folly/executors:async",
        "folly//folly/executors:manual_executor",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "CodelTest",
    srcs = ["CodelTest.cpp"],
    deps = [
        "folly//folly/executors:codel",
        "folly//folly/portability:gflags",
        "folly//folly/portability:gtest",
    ],
)

cpp_benchmark(
    name = "EDFThreadPoolExecutorBenchmark",
    srcs = ["EDFThreadPoolExecutorBenchmark.cpp"],
    headers = [],
    deps = [
        "folly//folly:benchmark",
        "folly//folly:benchmark_util",
        "folly//folly:mpmc_queue",
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:edf_thread_pool_executor",
        "folly//folly/executors:soft_real_time_executor",
        "folly//folly/executors:thread_pool_executor",
    ],
)

cpp_unittest(
    name = "FiberIOExecutorTest",
    srcs = ["FiberIOExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:fiber_io_executor",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "executor_test",
    srcs = ["ExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:inline_executor",
        "folly//folly/executors:manual_executor",
        "folly//folly/executors:queued_immediate_executor",
        "folly//folly/futures:core",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "GlobalExecutorTest",
    srcs = ["GlobalExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:global_executor",
        "folly//folly/executors:io_executor",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/executors:virtual_executor",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
        "folly//folly/synchronization:saturating_semaphore",
        "folly//folly/system:hardware_concurrency",
    ],
)

cpp_unittest(
    name = "GlobalCPUExecutorTest",
    srcs = ["GlobalCPUExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:global_executor",
        "folly//folly/executors:io_executor",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "GlobalIOExecutorTest",
    srcs = ["GlobalCPUExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:global_executor",
        "folly//folly/executors:io_executor",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "GlobalExecutorAssignmentTest",
    srcs = ["GlobalExecutorAssignmentTest.cpp"],
    deps = [
        "folly//folly:singleton",
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:global_executor",
        "folly//folly/executors:inline_executor",
        "folly//folly/executors:io_executor",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "SerialExecutorTest",
    srcs = ["SerialExecutorTest.cpp"],
    deps = [
        "folly//folly:random",
        "folly//folly:scope_guard",
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:inline_executor",
        "folly//folly/executors:serial_executor",
        "folly//folly/io/async:request_context",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "SequencedExecutorTest",
    srcs = ["SequencedExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:serial_executor",
        "folly//folly/io/async:scoped_event_base_thread",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "StrandExecutorTest",
    srcs = ["StrandExecutorTest.cpp"],
    deps = [
        "folly//folly:cancellation_token",
        "folly//folly/executors:global_executor",
        "folly//folly/executors:manual_executor",
        "folly//folly/executors:strand_executor",
        "folly//folly/io/async:request_context",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "ThreadedExecutorTest",
    srcs = ["ThreadedExecutorTest.cpp"],
    deps = [
        "folly//folly:conv",
        "folly//folly/executors:threaded_executor",
        "folly//folly/futures:core",
        "folly//folly/gen:base",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "ThreadPoolExecutorTest",
    srcs = ["ThreadPoolExecutorTest.cpp"],
    deps = [
        "folly//folly:c_portability",
        "folly//folly:default_keep_alive_executor",
        "folly//folly:exception",
        "folly//folly/container:f14_hash",
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:edf_thread_pool_executor",
        "folly//folly/executors:future_executor",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/executors:thread_pool_executor",
        "folly//folly/executors:virtual_executor",
        "folly//folly/executors/task_queue:lifo_sem_mpmc_queue",
        "folly//folly/executors/task_queue:unbounded_blocking_queue",
        "folly//folly/executors/thread_factory:init_thread_factory",
        "folly//folly/executors/thread_factory:priority_thread_factory",
        "folly//folly/lang:keep",
        "folly//folly/portability:gmock",
        "folly//folly/portability:gtest",
        "folly//folly/portability:pthread",
        "folly//folly/portability:sys_resource",
        "folly//folly/synchronization:latch",
        "folly//folly/synchronization/detail:spin",
        "folly//folly/system:thread_id",
    ],
    external_deps = [
        ("boost", None, "boost_thread"),
    ],
)

cpp_unittest(
    name = "TimedDrivableExecutorTest",
    srcs = ["TimedDrivableExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:timed_drivable_executor",
        "folly//folly/futures:core",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "TimekeeperScheduledExecutorTest",
    srcs = ["TimekeeperScheduledExecutorTest.cpp"],
    deps = [
        "folly//folly/executors:inline_executor",
        "folly//folly/executors:serial_executor",
        "folly//folly/executors:threaded_executor",
        "folly//folly/executors:timekeeper_scheduled_executor",
        "folly//folly/futures:manual_timekeeper",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
)

cpp_unittest(
    name = "ExecutorWithPriorityTest",
    srcs = ["ExecutorWithPriorityTest.cpp"],
    deps = [
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:executor_with_priority",
        "folly//folly/futures:core",
        "folly//folly/portability:gtest",
    ],
)

cpp_unittest(
    name = "MeteredExecutorTest",
    srcs = ["MeteredExecutorTest.cpp"],
    supports_static_listing = False,
    deps = [
        "folly//folly:synchronized",
        "folly//folly/executors:cpu_thread_pool_executor",
        "folly//folly/executors:metered_executor",
        "folly//folly/experimental/coro:blocking_wait",
        "folly//folly/experimental/coro:task",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
        "folly//folly/synchronization:lifo_sem",
        "folly//folly/test:deterministic_schedule",
    ],
)

cpp_unittest(
    name = "IOThreadPoolDeadlockDetectorObserverTest",
    srcs = ["IOThreadPoolDeadlockDetectorObserverTest.cpp"],
    deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly/concurrency:deadlock_detector",
        "folly//folly/executors:io_thread_pool_deadlock_detector_observer",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/portability:gtest",
    ],
    external_deps = [
        "glog",
    ],
)

cpp_library(
    name = "IOThreadPoolExecutorBaseTestLib",
    headers = [
        "IOThreadPoolExecutorBaseTestLib.h",
    ],
    exported_deps = [
        "fbsource//third-party/fmt:fmt",
        "folly//folly:random",
        "folly//folly/container:f14_hash",
        "folly//folly/executors:io_thread_pool_executor",
        "folly//folly/io/async:async_base",
        "folly//folly/portability:gtest",
        "folly//folly/synchronization:baton",
    ],
    exported_external_deps = [
        "glog",
    ],
)

cpp_unittest(
    name = "IOThreadPoolExecutorTest",
    srcs = ["IOThreadPoolExecutorTest.cpp"],
    supports_static_listing = False,
    deps = [
        ":IOThreadPoolExecutorBaseTestLib",
        "folly//folly/executors:io_thread_pool_executor",
    ],
)
